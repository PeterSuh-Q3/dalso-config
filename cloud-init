#!/bin/bash

# 스피너 함수 정의
spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='|/-\'
    while ps -p $pid > /dev/null; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

# 포어그라운드에서 실행할 부분
foreground_tasks() {
    echo "Starting foreground tasks..."

    # 호스트네임 입력 받기
    read -p "Enter hostname for this machine: " hostname
    echo "Setting hostname to $hostname..."
    hostnamectl set-hostname "$hostname"

    # IP 주소 입력 받기
    read -p "Enter static IP address (e.g., 192.168.1.100): " static_ip

    # 게이트웨이 주소 입력 받기
    read -p "Enter gateway address (e.g., 192.168.1.1): " gateway_ip

    # 패키지 업데이트
    if [ ! -f "/tmp/apt-updated" ]; then
        echo "Updating system packages..."
        apt update &> /dev/null &  # 백그라운드에서 실행
        spinner $!  # 스피너 표시
        apt upgrade -y
        echo "System packages updated."
        touch /tmp/apt-updated
    else
        echo "System packages are already up to date."
    fi

    # 한국 타임존 설정
    echo "Setting timezone to Asia/Seoul..."
    timedatectl set-timezone Asia/Seoul
    echo "Timezone set to Asia/Seoul."

    # .bashrc 파일 다운로드
    echo "Downloading .bashrc from GitHub..."
    curl -o /root/.bashrc https://raw.githubusercontent.com/dalso0418/ds-cloud-init/main/.bashrc
    echo ".bashrc downloaded and applied."

    # 필수 패키지 설치
    echo "Installing essential packages..."
    if ! package_installed "cloud-init"; then
        apt install cloud-init -y
    fi

    if ! package_installed "vim"; then
        apt install vim -y
    fi

    if ! package_installed "net-tools"; then
        apt install net-tools -y
    fi

    if ! package_installed "qemu-guest-agent"; then
        apt install qemu-guest-agent -y
    fi

    # qemu-guest-agent 서비스 활성화
    echo "Enabling qemu-guest-agent service..."
    if ! service_enabled "qemu-guest-agent"; then
        systemctl enable qemu-guest-agent
    fi
    echo "qemu-guest-agent service enabled."

    # Docker 설치
    echo "Installing Docker..."
    if ! command -v docker &> /dev/null; then
        curl -fsSL https://get.docker.com -o get-docker.sh
        sh get-docker.sh
        systemctl enable docker
    fi
    echo "Docker installed and enabled."

    ## Dockge 설정
    # Dockge 관련 디렉토리 생성 및 설정
    echo "Configuring Dockge..."
    mkdir -p /opt/stacks /opt/dockge
    cd /opt/dockge

    # compose.yaml 파일 다운로드
    echo "Downloading compose.yaml for Dockge..."
    curl -o compose.yaml https://raw.githubusercontent.com/louislam/dockge/master/compose.yaml
    echo "compose.yaml downloaded."

    # Docker Compose를 사용하여 서버 시작
    echo "Starting Dockge server with Docker Compose..."
    docker compose up -d
    echo "Dockge server started."

    # 네트워크 설정 파일 변경
    echo "Updating netplan configuration..."

    # 인터페이스 찾기
    interface=$(find_interface)
    echo "Found interface: $interface"

    # netplan 설정 파일 경로
    netplan_file="/etc/netplan/01-netcfg.yaml"

    # 파일의 존재 확인
    if [ -f "$netplan_file" ]; then
        # 파일의 내용을 백업
        cp "$netplan_file" "$netplan_file.backup"

        # 새로운 설정 파일 생성
        cat > "$netplan_file" <<EOF
network:
  version: 2
  ethernets:
    $interface:
      dhcp4: no
      addresses:
        - $static_ip/24
      routes:
        - to: 0.0.0.0/0
          via: $gateway_ip
      nameservers:
        addresses:
          - 8.8.8.8
          - 8.8.4.4
EOF

        echo "New configuration applied to $netplan_file."

        # 네트워크 설정 적용
        echo "Applying netplan configuration..."
        netplan apply
        echo "Netplan configuration applied."
    else
        echo "Netplan configuration file $netplan_file not found."
        echo "Aborting netplan configuration update."
    fi

    echo "Foreground tasks completed."
}

# 백그라운드에서 실행할 부분
background_tasks() {
    # 추가적인 백그라운드 작업이 필요하다면 여기에 추가할 수 있습니다.
    echo "Background tasks started."
}

# 백그라운드 작업 실행
background_tasks &

# 포어그라운드 작업 실행
foreground_tasks
